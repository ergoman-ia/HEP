<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>휴먼에러 확률(HEP) 평가도구</title>
    <style>
        /* 기본 스타일 및 레이아웃 설정 */
        :root {
            --primary-color: #005A9C; /* 전문적인 느낌의 파란색 */
            --secondary-color: #E8F0F6;
            --background-color: #F7F9FC;
            --text-color: #333;
            --border-color: #DDE3E9;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --danger-color: #D93025;
            --edit-color: #1A73E8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh; /* 전체 화면 높이 사용 */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center; /* 내부 요소 중앙 정렬 */
            padding-bottom: 20px;
        }

        header {
            width: 100%;
            padding: 20px 30px;
            background-color: var(--primary-color);
            color: #FFFFFF;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
            text-align: center;
        }

        main {
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            font-size: 18px;
            font-weight: bold;   
            color: #005A9C;
            display: block; /* 모바일에서 라벨이 한 줄 전체를 차지하도록 */
            margin-bottom: 5px;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 12px 24px; /* 버튼 크기 확대 */
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-width: 100px; /* 최소 너비 설정 */
        }
        
        .btn-small {
            padding: 10px 18px;
            font-size: 0.9em;
            min-width: auto;
        }

        .btn-primary {
            background-color: #FFFFFF;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: #FFFFFF;
        }
        .btn-danger:hover {
            opacity: 0.85;
        }
        .btn-edit {
            background-color: var(--edit-color);
            color: #FFFFFF;
        }
        .btn-edit:hover {
            opacity: 0.85;
        }

        /* 테이블 및 관리 기능 스타일 */
        .table-controls {
            display: flex;
            flex-wrap: wrap; /* 버튼이 모바일에서 줄바꿈되도록 */
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center; /* 버튼을 중앙으로 정렬 */
        }
        .table-controls button {
            background-color: #fff;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            flex-grow: 1; /* 버튼이 유연하게 확장되도록 */
        }
        .table-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* CSV 저장 버튼을 오른쪽으로 옮기기 위한 스타일 */
        .table-controls .right-aligned-btn {
            margin-left: 0;
            flex-grow: 1;
        }
        @media (min-width: 768px) {
            .table-controls {
                justify-content: flex-start;
            }
            .table-controls .right-aligned-btn {
                margin-left: auto;
                flex-grow: 0;
            }
        }
        
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 700px; /* 테이블이 너무 작아지지 않도록 최소 너비 설정 */
        }

        th, td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8em; /* 폰트 크기 조정 */
        }
        @media (min-width: 768px) {
            th, td {
                font-size: 1em; /* 데스크톱에서는 원래 크기로 */
            }
        }

        th {
            background-color: var(--secondary-color);
            font-weight: 600;
            color: var(--primary-color);
            position: sticky; /* 헤더 고정 */
            top: 0;
            z-index: 10;
        }

        tbody tr:nth-child(even) {
            background-color: #FDFDFD;
        }
        
        tbody tr.selected {
            background-color: var(--secondary-color);
        }

        td.actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        /* 설문 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* 기본 숨김 */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #FFFFFF;
            padding: 30px;
            border-radius: 12px;
            width: 95%; /* 모바일에서 더 넓게 사용 */
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #no-task-message {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        
        /* -- 수정된 부분 시작 -- */
        /* 작업명 입력란 크기 확대 */
        #taskNameInput {
            font-size: 1.0em; 
            padding: 10px; /* 패딩 조정 */
            width: 100%;
            box-sizing: border-box;
        }

        /* 테이블 내용 폰트 크기 축소 */
        .table-container td {
            font-size: 70%;
        }
        .table-container td:not(:nth-child(2)) {
            font-size: 90%;
        }
        .table-container td:nth-child(2),
        .table-container td:nth-child(11),
        .table-container td:nth-child(12) {
            font-size: 100%;
            font-weight: bold;
        }
        
        /* 설문 문항 스타일 */
        .question-group legend {
            background-color: var(--primary-color);
            color: #FFFFFF;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        /* 모바일용 설문지 라디오 버튼 레이아웃 */
        .radio-options {
            display: flex;
            flex-wrap: wrap; /* 항목들이 여러 줄로 배치되도록 */
            gap: 8px;
            justify-content: center;
        }
        .radio-options label {
            flex-grow: 1; /* 버튼이 유연하게 확장되도록 */
            min-width: 120px;
            padding: 10px;
            font-size: 0.9em;
        }
        /* -- 수정된 부분 끝 -- */

        /* 체크리스트 실행여부 칸 스타일 */
        .status-cell {
            font-weight: bold;
            cursor: pointer;
            width: 80px;
            font-size: 1.2em;
        }

        /* 인쇄 시 스타일 */
        @media print {
            body > *:not(.modal-overlay) {
                display: none;
            }
            .modal-overlay {
                display: flex;
                position: static;
                width: auto;
                height: auto;
                background: none;
            }
            .modal-content {
                box-shadow: none;
                max-width: 100%;
                width: 100%;
            }
            .modal-actions {
                display: none; /* 인쇄 시 버튼 숨기기 */
            }
            .status-cell {
                cursor: default; /* 인쇄 시 커서 변경 */
            }
        }
        /* ㅁ 아이콘 크기 키우기 */
        .check-box {
            font-size: 1.5rem; /* 기존 폰트 크기보다 크게 설정 */
        }
        /* 체크리스트 굵기 수정 */
        #preventionList td {
            font-weight: normal; /* 모든 텍스트의 굵기 초기화 */
        }
        #preventionList td strong {
            font-weight: bold; /* strong 태그가 있는 부분만 굵게 */
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>휴먼에러 확률(HEP) 평가</h1>
    </header>
    <main>
        <div class="table-controls">
            <button id="addTaskBtn" class="btn btn-primary" onclick="openSurveyModal()">작업 추가</button>
            <button id="moveUpBtn" class="btn btn-small" onclick="moveRow('up')" disabled>위로 ▲</button>
            <button id="moveDownBtn" class="btn btn-small" onclick="moveRow('down')" disabled>아래로 ▼</button>
            <!-- 휴먼에러 예방 설문지 버튼 추가 -->
            <button id="preventionBtn" class="btn btn-primary right-aligned-btn" onclick="openPreventionChecklist()" style="background-color: #28a745; color: white;">체크리스트 도출</button>            
        </div>
        <div class="table-container">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">선택</th>
                        <th style="width: 150px;">작업명</th>
                        <th>가능성</th>
                        <th>중대성</th>
                        <th>난이도</th>
                        <th>환경</th>
                        <th>집중도</th>
                        <th>절차</th>
                        <th>시간압박</th>
                        <th>경험</th>
                        <th>HEP</th>
                        <th>성공 확률</th>
                        <th style="width: 120px;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="no-task-message">
                        <td colspan="13">아직 평가된 작업이 없습니다.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- 설문조사 모달 -->
<div class="modal-overlay" id="surveyModal">
    <div class="modal-content">
        <h1 align="center" id="modalTitle">작업 평가</h1>
        <form id="hepSurveyForm" onsubmit="submitSurvey(event)">
            <input type="hidden" id="editingRowId">
            <div class="form-group">
                <label for="taskNameInput">▶ 평가할 대상 작업명 : </label>
                <input type="text" id="taskNameInput" placeholder="예: 밸브 잠금 작업" required>
            </div>
            <p></p>
            <div id="surveyQuestions"></div>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button type="button" class="btn" onclick="closeSurveyModal()">취소</button>
                <button type="submit" id="submitBtn" class="btn btn-primary" style="background-color: var(--primary-color); color: #fff;">추가</button>
            </div>
        </form>
    </div>
</div>

<!-- 휴먼에러 예방 체크리스트 모달 -->
<div class="modal-overlay" id="preventionModal">
    <div class="modal-content">
        <h2 id="preventionModalTitle" style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">휴먼에러 예방 체크리스트</h2>
        <div class="table-container">
            <table id="preventionTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">번호</th>
                        <th style="width: 70%;">체크리스트</th>
                        <th>실행여부</th>
                    </tr>
                </thead>
                <tbody id="preventionList">
                    <!-- 체크리스트 항목이 여기에 동적으로 추가됩니다. -->
                </tbody>
            </table>
        </div>
        <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-primary" onclick="window.print()" style="background-color: #555; color: white;">인쇄</button>
            <button type="button" class="btn" onclick="closePreventionModal()">닫기</button>
        </div>
    </div>
</div>


<script>
    // 설문 질문과 선택지 데이터
    const surveyData = {
        likelihood: { question: "1. 이 작업에서 사고가 발생할 가능성(빈도)은 얼마나 됩니까?", options: ["매우 낮음", "낮음", "보통", "높음", "매우 높음"] },
        severity: { question: "2. 만약 사고가 발생한다면, 그 결과(인적/물적 피해)는 얼마나 심각합니까?", options: ["경미함", "주의 필요", "심각함", "치명적", "재앙적"] },
        // PSF 항목 추가
        difficulty: { question: "3. 수행하려는 작업은 얼마나 어렵습니까?", options: ["매우 쉬움", "쉬움", "보통", "어려움", "매우 어려움"] },
        environment: { question: "4. 작업 환경(소음, 조명, 공간 등)은 얼마나 쾌적합니까?", options: ["매우 쾌적함", "쾌적함", "보통", "불편함", "매우 불편함"] },
        attention: { question: "5. 이 작업을 수행하는 데 어느 정도의 집중력이 필요합니까?", options: ["거의 불필요", "조금 필요", "보통", "높은 집중", "최고 수준"] },
        procedure: { question: "6. 작업 절차나 지침은 얼마나 명확하고 이해하기 쉽습니까?", options: ["매우 명확함", "명확함", "보통", "불명확함", "매우 불명확함"] },
        timePressure: { question: "7. 주어진 시간 안에 작업을 완료해야 한다는 압박감을 얼마나 느끼십니까?", options: ["전혀 없음", "조금 느낌", "보통", "많이 느낌", "매우 많이 느낌"] },
        experience: { question: "8. 이 작업 또는 유사한 작업에 대한 경험은 얼마나 충분합니까?", options: ["매우 충분함", "충분함", "보통", "부족함", "매우 부족함"] }
    };

    // 기본 HEP 계산을 위한 가중치 (최소, 최대)
    const hepWeights = {
        difficulty: [0.001, 0.1],
        environment: [0.001, 0.15],
        attention: [0.001, 0.1],
        procedure: [0.001, 0.2],
        timePressure: [0.001, 0.18],
        experience: [0.001, 0.2]
    };
    
    // 가능성 및 중대성 가중치 승수
    const riskMultipliers = {
        likelihood: [0.8, 1.0, 1.2, 1.5, 2.0],
        severity: [0.8, 1.0, 1.5, 2.5, 3.5]
    };

    // PSF 점수에 따른 예방 대책 (점수 3, 4, 5에 대해 2개씩)
    const preventionData = {
        difficulty: {
            3: [
                "<strong>(난이도)</strong> 작업 중 발생할 수 있는 잠재적 위험 요소를 식별하고, 비상 상황 대비 훈련을 계획하십시오.",
                "<strong>(난이도)</strong> 예상치 못한 상황에 대비하여 복잡한 작업 과정을 시뮬레이션하고, 팀원 간 역할을 명확히 하십시오."
            ],
            4: [
                "<strong>(난이도)</strong> 작업 단계를 더 세분화하고, 복잡한 부분에 대한 체크리스트를 별도로 작성하여 활용하십시오.",
                "<strong>(난이도)</strong> 복잡한 작업의 흐름을 시각화(Visual Management)하여 한눈에 파악할 수 있도록 게시하십시오."
            ],
            5: [
                "<strong>(난이도)</strong> 작업을 자동화하거나, 보조 장치(Jig)를 도입하여 작업자의 인지적 부하를 최소화하십시오.",
                "<strong>(난이도)</strong> 작업의 핵심 절차를 간소화하거나, 다른 작업으로 분할하여 한 번에 처리하는 정보량을 줄이십시오."
            ]
        },
        environment: {
            3: [
                "<strong>(환경)</strong> 작업 환경의 변동 요인을 파악하고, 작업자가 인지할 수 있는 시각적 신호(표지판, 알림 등)를 설치하십시오.",
                "<strong>(환경)</strong> 작업 효율을 저해하는 불필요한 물품이나 장애물을 제거하고, 정리정돈 상태를 정기적으로 점검하십시오."
            ],
            4: [
                "<strong>(환경)</strong> 불필요한 소음을 제거하고 조명을 개선하는 등 물리적 환경을 개선하여 작업자의 집중도를 향상시키십시오.",
                "<strong>(환경)</strong> 작업자의 심리적 안정감을 위해 작업 공간의 색채, 배치 등을 재조정하여 쾌적한 환경을 조성하십시오."
            ],
            5: [
                "<strong>(환경)</strong> 위험 요소가 있는 작업 환경에 대해 원격 모니터링 시스템을 구축하고, 개인 보호 장비(PPE) 착용을 의무화하십시오.",
                "<strong>(환경)</strong> 작업 장소에 유해 물질이나 위험 요소가 있다면, 즉시 제거하거나 접근을 차단하는 통제 구역을 설정하십시오."
            ]
        },
        attention: {
            3: [
                "<strong>(집중도)</strong> 중요한 작업 단계에서는 'Stop and Think'와 같이 작업자가 잠시 멈춰서 다음 단계를 확인하는 습관을 들이십시오.",
                "<strong>(집중도)</strong> 업무 시작 전 5분간 '안전 TBM(Tool Box Meeting)'을 통해 오늘 작업의 중요 포인트를 상기시키고 집중도를 높이십시오."
            ],
            4: [
                "<strong>(집중도)</strong> 명확한 경고 표지나 알림 시스템을 도입하여 작업자의 주의를 환기시키고 실수를 예방하십시오.",
                "<strong>(집중도)</strong> 실수 유발 가능성이 높은 지점(Error-Prone Area)에 시각적/청각적 경고 장치를 설치하여 작업자의 주의를 끌도록 하십시오."
            ],
            5: [
                "<strong>(집중도)</strong> 높은 집중이 필요한 작업은 2인 1조로 수행하고, 상호 확인(Cross-Check) 절차를 의무화하십시오.",
                "<strong>(집중도)</strong> 작업 중 발생할 수 있는 인지적 부하를 줄이기 위해 작업 순서에 따라 도구와 재료를 미리 배치하는 등 '포카요케(Poka-Yoke)'를 적용하십시오."
            ]
        },
        procedure: {
            3: [
                "<strong>(절차)</strong> 작업 절차에 대한 정기적인 훈련과 평가를 실시하여 절차에 대한 이해도를 높이십시오.",
                "<strong>(절차)</strong> 작업 절차서에 자주 발생하는 실수의 유형과 예방 조치를 구체적으로 명시하여 작업자가 숙지하도록 하십시오."
            ],
            4: [
                "<strong>(절차)</strong> 복잡하거나 중요한 절차를 그림, 도표, 혹은 동영상으로 제작하여 직관적인 이해를 돕도록 하십시오.",
                "<strong>(절차)</strong> 작업자가 현장에서 실시간으로 절차서를 확인할 수 있도록 QR 코드 등 디지털 접근 수단을 제공하십시오."
            ],
            5: [
                "<strong>(절차)</strong> 작업 절차의 각 단계마다 완료를 확인하는 체크리스트를 포함하고, 서명 절차를 추가하여 책임감을 부여하십시오.",
                "<strong>(절차)</strong> 핵심 작업에 대해서는 절차의 중요성과 오류 발생 시의 파급 효과를 강조하는 별도의 교육 프로그램을 개발하여 운영하십시오."
            ]
        },
        timePressure: {
            3: [
                "<strong>(시간압박)</strong> 작업자가 작업량과 시간 압박에 대해 관리자와 소통할 수 있는 채널을 마련하고, 주기적으로 검토하십시오.",
                "<strong>(시간압박)</strong> 예정된 작업과 실제 작업 시간을 비교하고, 지연이 발생하는 원인을 분석하여 개선책을 마련하십시오."
            ],
            4: [
                "<strong>(시간압박)</strong> 작업의 우선순위를 명확히 설정하고, 중요하지 않은 작업은 과감하게 연기하거나 위임하도록 하십시오.",
                "<strong>(시간압박)</strong> 시간 압박이 심한 작업은 작업 인원을 증원하거나, 작업을 재분배하여 부담을 완화하도록 하십시오."
            ],
            5: [
                "<strong>(시간압박)</strong> 인력이나 자원이 부족한 경우 즉시 추가 지원을 요청하고, 작업량을 분산하여 압박감을 줄이십시오.",
                "<strong>(시간압박)</strong> 작업 시간 관리를 위한 시스템을 도입하여 작업자가 자신의 진행 상황을 실시간으로 확인하고, 스스로 속도를 조절할 수 있도록 유도하십시오."
            ]
        },
        experience: {
            3: [
                "<strong>(경험)</strong> 다양한 작업 경험을 쌓을 수 있도록 순환 근무(Job Rotation) 제도를 도입하십시오.",
                "<strong>(경험)</strong> 작업자가 유사한 작업 경험을 통해 기술을 확장할 수 있도록 교육 프로그램을 구성하고, 정기적으로 평가하십시오."
            ],
            4: [
                "<strong>(경험)</strong> 경험이 부족한 작업자는 숙련된 멘토와 함께 작업하도록 하여 실수를 줄이고 기술을 습득하도록 하십시오.",
                "<strong>(경험)</strong> 팀 내에서 '베테랑'과 '신입'이 짝을 이루는 버디 시스템을 공식적으로 운영하여 지식 전수를 활성화하십시오."
            ],
            5: [
                "<strong>(경험)</strong> 작업자의 경험과 숙련도에 따라 작업 배정을 차등화하고, 충분한 훈련 없이는 복잡한 작업을 맡기지 않도록 하십시오.",
                "<strong>(경험)</strong> 작업자별 역량 평가(Skill Matrix)를 작성하고, 부족한 기술에 대해 맞춤형 훈련을 제공하는 체계를 구축하십시오."
            ]
        }
    };


    function scaleEPC(value, minHEP, maxHEP) {
        const ratio = (value - 1) / 4;
        return minHEP + ratio * (maxHEP - minHEP);
    }
    
    function generateSurveyQuestions() {
        const questionsContainer = document.getElementById('surveyQuestions');
        let html = '';
        const order = ['likelihood', 'severity', 'difficulty', 'environment', 'attention', 'procedure', 'timePressure', 'experience'];
        
        order.forEach(key => {
            const item = surveyData[key];
            html += `<fieldset class="question-group" style="margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; font-size:17px;">`;
            html += `<legend style="font-weight: 600; padding: 5px 10px; text-align: left; background-color: var(--primary-color); color: #FFFFFF; border-radius: 6px;">${item.question}</legend>`;
            html += `<div class="radio-options" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">`;
            item.options.forEach((option, index) => {
                const value = index + 1;
                html += `
                    <input type="radio" id="${key}-${value}" name="${key}" value="${value}" style="display: none;">
                    <label for="${key}-${value}" style="display: block; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; text-align: center; flex-grow: 1; font-size: 0.9em; min-width: 120px;">${option}</label>
                `;
            });
            html += `</div></fieldset>`;
        });
        questionsContainer.innerHTML = html;
        document.querySelectorAll('.radio-options input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(r => {
                    r.nextElementSibling.style.backgroundColor = '';
                    r.nextElementSibling.style.color = '';
                    r.nextElementSibling.style.borderColor = 'var(--border-color)';
                });
                if(e.target.checked) {
                    const label = e.target.nextElementSibling;
                    label.style.backgroundColor = 'var(--secondary-color)';
                    label.style.color = 'var(--primary-color)';
                    label.style.borderColor = 'var(--primary-color)';
                }
            });
        });
    }

    function submitSurvey(event) {
        event.preventDefault();
        const editingRowId = document.getElementById('editingRowId').value;
        const taskName = document.getElementById('taskNameInput').value;
        const formData = new FormData(event.target);
        const values = { name: taskName };
        
        const keys = ['likelihood', 'severity', 'difficulty', 'environment', 'attention', 'procedure', 'timePressure', 'experience'];
        for (const key of keys) {
            const value = formData.get(key);
            if (!value) {
                alert("모든 질문에 답변해주세요.");
                return;
            }
            values[key] = parseInt(value);
        }

        const baseHepValues = {};
        const hepKeys = ['difficulty', 'environment', 'attention', 'procedure', 'timePressure', 'experience'];
        for (const key of hepKeys) {
            baseHepValues[key] = scaleEPC(values[key], hepWeights[key][0], hepWeights[key][1]);
        }
        const baseHEP = Math.pow(Object.values(baseHepValues).reduce((a, b) => a * b, 1), 1 / 6);
        const finalHEP = Math.min(Math.max(baseHEP * riskMultipliers.likelihood[values.likelihood - 1] * riskMultipliers.severity[values.severity - 1], 0.001), 1.0);
        values.hep = finalHEP.toFixed(3);
        values.successProbability = (1.0 - parseFloat(values.hep)).toFixed(3);

        if (editingRowId) {
            updateTaskInTable(document.getElementById(editingRowId), values);
        } else {
            addTaskToTable(values);
        }
        closeSurveyModal();
    }

    function addTaskToTable(taskData) {
        const tableBody = document.getElementById('taskTable').querySelector('tbody');
        const noTaskMessage = document.getElementById('no-task-message');
        if (noTaskMessage) noTaskMessage.remove();

        const newRow = tableBody.insertRow();
        newRow.id = `task-${Date.now()}`;
        updateTaskInTable(newRow, taskData);
    }

    function updateTaskInTable(row, taskData) {
        for (const key in taskData) {
            row.dataset[key] = taskData[key];
        }
        
        const likelihoodText = surveyData.likelihood.options[taskData.likelihood - 1];
        const severityText = surveyData.severity.options[taskData.severity - 1];

        row.innerHTML = `
            <td><input type="checkbox" name="task_select" onchange="handleCheckboxChange(this)"></td>
            <td>${taskData.name}</td>
            <td>${likelihoodText}</td>
            <td>${severityText}</td>
            <td>${surveyData.difficulty.options[taskData.difficulty - 1]}</td>
            <td>${surveyData.environment.options[taskData.environment - 1]}</td>
            <td>${surveyData.attention.options[taskData.attention - 1]}</td>
            <td>${surveyData.procedure.options[taskData.procedure - 1]}</td>
            <td>${surveyData.timePressure.options[taskData.timePressure - 1]}</td>
            <td>${surveyData.experience.options[taskData.experience - 1]}</td>
            <td><strong>${taskData.hep}</strong></td>
            <td><strong>${taskData.successProbability}</strong></td>
            <td class="actions">
                <button class="btn btn-small btn-edit" onclick="editTask(this)">수정</button>
                <button class="btn btn-small btn-danger" onclick="deleteTask(this)">삭제</button>
            </td>
        `;
    }

    function editTask(button) {
        const row = button.closest('tr');
        openSurveyModal(row);
    }

    function deleteTask(button) {
        const row = button.closest('tr');
        const tableBody = row.parentNode;
        row.remove();
        
        if (tableBody.rows.length === 0) {
            tableBody.innerHTML = `<tr id="no-task-message"><td colspan="13">아직 평가된 작업이 없습니다.</td></tr>`;
        }
        updateMoveButtonsState();
    }
    
    function openSurveyModal(row = null) {
        const form = document.getElementById('hepSurveyForm');
        form.reset();
        document.getElementById('editingRowId').value = '';
        
        document.querySelectorAll('.radio-options label').forEach(label => {
            label.style.backgroundColor = '';
            label.style.color = '';
            label.style.borderColor = '';
        });

        if (row) { // 수정 모드
            document.getElementById('modalTitle').textContent = '작업 평가 수정';
            document.getElementById('submitBtn').textContent = '수정 완료';
            document.getElementById('editingRowId').value = row.id;
            document.getElementById('taskNameInput').value = row.dataset.name;
            for (const key in surveyData) {
                const value = row.dataset[key];
                if (value) {
                    const radio = form.querySelector(`input[name="${key}"][value="${value}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
            }
        } else { // 생성 모드
            document.getElementById('modalTitle').textContent = '작업 평가';
            document.getElementById('submitBtn').textContent = '추가하기';
            for (const key in surveyData) {
                const radio = form.querySelector(`input[name="${key}"][value="3"]`);
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
            }
        }
        document.getElementById('surveyModal').style.display = 'flex';
    }

    function closeSurveyModal() {
        document.getElementById('surveyModal').style.display = 'none';
    }

    function openPreventionChecklist() {
        const checkedBox = document.querySelector('input[name="task_select"]:checked');
        if (!checkedBox) {
            alert("먼저 체크리스트를 생성할 작업을 선택해주세요.");
            return;
        }

        const row = checkedBox.closest('tr');
        const taskData = row.dataset;
        const preventionList = document.getElementById('preventionList');
        preventionList.innerHTML = ''; // 기존 목록 초기화

        document.getElementById('preventionModalTitle').textContent = `[${taskData.name}] 휴먼에러 예방 체크리스트`;

        let hasItems = false;
        let counter = 1;
        
        // 카테고리명을 매핑하는 객체
        const categoryMap = {
            difficulty: '난이도',
            environment: '환경',
            attention: '집중도',
            procedure: '절차',
            timePressure: '시간압박',
            experience: '경험'
        };

        for (const key in preventionData) {
            const score = taskData[key];
            if (preventionData[key] && preventionData[key][score]) {
                hasItems = true;
                const suggestions = preventionData[key][score];
                const selectedSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                
                const newRow = preventionList.insertRow();
                newRow.insertCell(0).textContent = counter;
                newRow.insertCell(1).innerHTML = selectedSuggestion; // HTML로 변경하여 bold 태그 적용
                newRow.insertCell(2).innerHTML = '<span class="check-box">□</span>'; // 체크박스 문자열로 변경
                
                newRow.cells[1].style.textAlign = 'left';
                newRow.cells[0].style.textAlign = 'center';
                newRow.cells[2].style.textAlign = 'center';
                
                counter++;
            }
        }

        if (!hasItems) {
            const newRow = preventionList.insertRow();
            const cell = newRow.insertCell(0);
            cell.colSpan = 3;
            cell.textContent = "해당 작업은 현재 PSF 수준이 양호하여 별도의 개선 권장사항이 없습니다.";
            cell.style.textAlign = 'center';
        }

        document.getElementById('preventionModal').style.display = 'flex';
    }

    function closePreventionModal() {
        document.getElementById('preventionModal').style.display = 'none';
    }


    function handleCheckboxChange(checkbox) {
        document.querySelectorAll('input[name="task_select"]').forEach(cb => {
            if (cb !== checkbox) cb.checked = false;
        });
        updateMoveButtonsState();
    }

    function updateMoveButtonsState() {
        const checkedBox = document.querySelector('input[name="task_select"]:checked');
        const moveUpBtn = document.getElementById('moveUpBtn');
        const moveDownBtn = document.getElementById('moveDownBtn');

        document.querySelectorAll('tbody tr').forEach(row => row.classList.remove('selected'));

        if (!checkedBox) {
            moveUpBtn.disabled = true;
            moveDownBtn.disabled = true;
            return;
        }
        
        const row = checkedBox.closest('tr');
        row.classList.add('selected');
        moveUpBtn.disabled = !row.previousElementSibling;
        moveDownBtn.disabled = !row.nextElementSibling;
    }

    function moveRow(direction) {
        const checkedBox = document.querySelector('input[name="task_select"]:checked');
        if (!checkedBox) return;

        const row = checkedBox.closest('tr');
        if (direction === 'up' && row.previousElementSibling) {
            row.parentNode.insertBefore(row, row.previousElementSibling);
        } else if (direction === 'down' && row.nextElementSibling) {
            row.parentNode.insertBefore(row.nextElementSibling, row);
        }
        updateMoveButtonsState();
    }
    
    function saveTableAsCsv() {
        const table = document.getElementById('taskTable');
        const rows = table.querySelectorAll('tbody tr');
        let csv = "작업 단계,성공 확률\n";
        
        rows.forEach(row => {
            if (row.id === 'no-task-message') return;

            const taskName = `"${row.dataset.name.replace(/"/g, '""')}"`;
            const successProbability = row.dataset.successProbability;
            
            csv += `${taskName},${successProbability}\n`;
        });
        
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'hep_results.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', () => {
        generateSurveyQuestions();
    });

</script>
</body>
</html>

